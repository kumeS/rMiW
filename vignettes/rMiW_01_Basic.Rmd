---
title: "rMiW: 01. Providing a basic workflow for microscopy-based images"
author: 
- name: Satoshi Kume
  email: satoshi.kume.1984@gmail.com
date: "`r Sys.Date()`"
graphics: no
package: rMiW
output:
    BiocStyle::html_document:
        toc_float: false
vignette: >
    %\VignetteIndexEntry{rMiW}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

**Last modified:** `r file.info("rMiW_01_Kidney.Rmd")$mtime`<br />
**Compiled**: `r date()`

# Getting started

```{r echo=TRUE, eval=FALSE}
#Load package
library(rMiW)
```

# Import a kidney image from rMiW

The displayed image (`Mouse01_Kid_x20_z0_RR01.png') is an image of whole slide imaging (WSI) for observing the mouse P0 kidney tissue stained by H&E. 

```{r echo=TRUE, eval=FALSE}
file <- system.file("extdata", "Mouse01_Kid_x20_z0_RR01.png", package="rMiW")

#Visualization
EBImage::display(EBImage::readImage(files = file), method = "raster")
```

```{r Fig001, out.width = '75%', fig.cap = "Mouse01_Kid_x20_z0_RR01.png", echo = FALSE}
options(EBImage.display = "raster")
file <- system.file("extdata", "Mouse01_Kid_x20_z0_RR01.png", package="rMiW")
img <- EBImage::resize(EBImage::readImage(files = file), w = 500)
EBImage::display(img, method = "raster")
```

# Basic image processing

## Convert to the grey image

```{r echo=TRUE, eval=FALSE}
#Read image: delete the 4th element of 3th dimension
Img <- EBImage::readImage(files = file)

#Convert to the gray image
GrayImg <- toGrayScale(Img, mode = "luminance")

#Visualization
EBImage::display(GrayImg, method = "raster")
```

```{r Fig002, out.width = '75%', fig.cap = "The gray image of Mouse01_Kid_x20_z0_RR01.png", echo = FALSE}
file <- system.file("extdata", "Mouse01_Kid_x20_z0_RR01.png", package="rMiW")
img <- rMiW::toGrayScale(EBImage::resize(EBImage::readImage(files = file), w = 500), mode = "luminance")
EBImage::display(img, method = "raster")
```

## Resize the image

```{r echo=TRUE, eval=FALSE}
#1% area size
Img10 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.1, 0), filter = "bilinear")

#6% area size
Img25 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.25, 0), filter = "bilinear")

#25% area size
Img50 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.5, 0), filter = "bilinear")

#50% area size
Img70 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.707, 0), filter = "bilinear")

#Visualization
par(mfrow=c(2,2))
EBImage::display(Img10, method = "raster")
text(x = dim(Img10)[1]/20, y = dim(Img10)[2]/10, label = "1% area size", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Img25, method = "raster")
text(x = dim(Img25)[1]/20, y = dim(Img25)[2]/10, label = "6% area size", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Img50, method = "raster")
text(x = dim(Img50)[1]/20, y = dim(Img50)[2]/10, label = "25% area size", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Img70, method = "raster")
text(x = dim(Img70)[1]/20, y = dim(Img70)[2]/10, label = "50% area size", adj = c(0,0), col = "black", cex = 1.5)
```

```{r Fig003, out.width = '100%', fig.cap = "The resized images of Mouse01_Kid_x20_z0_RR01.png", echo = FALSE}
#Read image
file <- system.file("extdata", "Mouse01_Kid_x20_z0_RR01.png", package="rMiW")
Img <- EBImage::readImage(files = file)

#1% area size
Img10 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.1, 0), filter = "bilinear")
#6% area size
Img25 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.25, 0), filter = "bilinear")
#25% area size
Img50 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.5, 0), filter = "bilinear")
#50% area size
Img70 <- EBImage::resize(Img, w = round(dim(Img)[1]*0.707, 0), filter = "bilinear")

par(mfrow=c(2,2))
EBImage::display(Img10, method = "raster")
text(x = dim(Img10)[1]/20, y = dim(Img10)[2]/10, label = "1% area size", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Img25, method = "raster")
text(x = dim(Img25)[1]/20, y = dim(Img25)[2]/10, label = "6% area size", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Img50, method = "raster")
text(x = dim(Img50)[1]/20, y = dim(Img50)[2]/10, label = "25% area size", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Img70, method = "raster")
text(x = dim(Img70)[1]/20, y = dim(Img70)[2]/10, label = "50% area size", adj = c(0,0), col = "black", cex = 1.5)
```

## Transpose the image

```{r echo=TRUE, eval=FALSE}
#Transpose the image
ImgTrans <- EBImage::transpose(Img)

#Flip or flop the image
Imgflip <- EBImage::flip(Img)
Imgflop <- EBImage::flop(Img)

#Visualization
par(mfrow=c(2,2))
EBImage::display(Img, method = "raster")
text(x = dim(Img)[1]/20, y = dim(Img)[2]/10, label = "Original", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(ImgTrans, method = "raster")
text(x = dim(ImgTrans)[1]/20, y = dim(ImgTrans)[2]/10, label = "Transpose", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Imgflip, method = "raster")
text(x = dim(Imgflip)[1]/20, y = dim(Imgflip)[2]/10, label = "Flip", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Imgflop, method = "raster")
text(x = dim(Imgflop)[1]/20, y = dim(Imgflop)[2]/10, label = "Flop", adj = c(0,0), col = "black", cex = 1.5)
```

```{r Fig004, out.width = '100%', fig.cap = "The rotated images of Mouse01_Kid_x20_z0_RR01.png", echo = FALSE}
#Read image
file <- system.file("extdata", "Mouse01_Kid_x20_z0_RR01.png", package="rMiW")
Img <- EBImage::readImage(files = file)

#Transpose the image
ImgTrans <- EBImage::transpose(Img)

#Flip or flop the image
Imgflip <- EBImage::flip(Img)
Imgflop <- EBImage::flop(Img)

#Visualization
par(mfrow=c(2,2))
EBImage::display(Img, method = "raster")
text(x = dim(Img)[1]/20, y = dim(Img)[2]/10, label = "Original", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(ImgTrans, method = "raster")
text(x = dim(ImgTrans)[1]/20, y = dim(ImgTrans)[2]/10, label = "Transpose", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Imgflip, method = "raster")
text(x = dim(Imgflip)[1]/20, y = dim(Imgflip)[2]/10, label = "Flip", adj = c(0,0), col = "black", cex = 1.5)
EBImage::display(Imgflop, method = "raster")
text(x = dim(Imgflop)[1]/20, y = dim(Imgflop)[2]/10, label = "Flop", adj = c(0,0), col = "black", cex = 1.5)
```

# Basic clustering using k-means

## The clustering with a compressed image of 1024x1024px 

```{r echo=TRUE, eval=FALSE}
#Read image: delete the 4th element of 3th dimension
Img <- readRDS(system.file("extdata", "Mouse01_Kid_x20_z0_RR01.Rds", package="rMiW"))
str(Img)

#Resize 1024x1024 and perform 3 clustering 
ImgClus3 <- Img2DClustering(x=Img, Cluster = 3, XY=1024)
#Visualize as a color image
rasterMiW(ImgClus3, method = "raster")

#Resize 1024x1024 and perform 4 clustering 
ImgClus4 <- Img2DClustering(x=Img, Cluster = 4, XY=1024)
#Visualize as a color image
rasterMiW(ImgClus4)

```

# Session information {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```



